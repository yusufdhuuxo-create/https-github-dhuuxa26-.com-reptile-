{% extends "base.html" %}

{% block title %}Generate Codes - CodeVault{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Generate Activation Codes</h1>
    <p>Create secure, customizable activation codes</p>
</div>

<div class="grid grid-2">
    <div class="glass-card animate-in">
        <div class="card-header">
            <h2 class="card-title">
                <span class="card-title-icon icon-purple">‚öôÔ∏è</span>
                Configuration
            </h2>
        </div>
        <form method="POST" id="generate-form">
            <div class="form-group">
                <label class="form-label" for="count">Number of Codes</label>
                <input type="number" class="form-input" id="count" name="count" min="1" max="100" value="1">
                <p class="form-hint">Generate 1-100 codes at once</p>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="prefix">Code Prefix</label>
                <input type="text" class="form-input mono" id="prefix" name="prefix" maxlength="10" placeholder="e.g., PROMO, VIP, BETA">
                <p class="form-hint">Add a custom prefix for easy identification</p>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="name">Batch Name</label>
                <input type="text" class="form-input" id="name" name="name" placeholder="e.g., Summer Campaign 2024">
                <p class="form-hint">Name this batch for organization</p>
            </div>
            
            <div class="grid grid-2" style="gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="uses_allowed">Uses Per Code</label>
                    <input type="number" class="form-input" id="uses_allowed" name="uses_allowed" min="1" max="1000" value="1">
                    <p class="form-hint">Max activations per code</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="expires_days">Expires After (Days)</label>
                    <input type="number" class="form-input" id="expires_days" name="expires_days" min="1" max="365" placeholder="Never">
                    <p class="form-hint">Leave empty for no expiration</p>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                ‚ú® Generate Codes
            </button>
        </form>
    </div>
    
    <div class="glass-card animate-in" style="animation-delay: 0.1s;">
        <div class="card-header">
            <h2 class="card-title">
                <span class="card-title-icon icon-cyan">üìã</span>
                Generated Codes
            </h2>
            {% if generated_codes %}
                <span class="badge badge-success">{{ generated_codes|length }} codes</span>
            {% endif %}
        </div>
        
        {% if generated_codes %}
            <div style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                {% for code in generated_codes %}
                    <div class="code-display">
                        <span>{{ code }}</span>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if code in qr_codes %}
                                <button class="btn btn-ghost btn-icon" onclick="showQR('{{ code }}', '{{ qr_codes[code] }}')" title="Show QR Code">
                                    üì±
                                </button>
                            {% endif %}
                            <button class="btn btn-ghost btn-icon" onclick="copyToClipboard('{{ code }}', this)" title="Copy">
                                üìã
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="copyAllCodes()">
                    üìã Copy All
                </button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="downloadCSV()">
                    üì• Export CSV
                </button>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üîë</div>
                <p>Generated codes will appear here</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem; color: var(--text-muted);">Configure options and click generate</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="glass-card animate-in" style="margin-top: 1.5rem; animation-delay: 0.2s;">
    <div class="card-header">
        <h2 class="card-title">
            <span class="card-title-icon icon-green">üí°</span>
            Code Format Preview
        </h2>
    </div>
    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
        <div>
            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Without Prefix</div>
            <code class="mono" style="font-size: 1.25rem; color: var(--primary-light);">ABCD-EFGH-IJKL</code>
        </div>
        <div>
            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">With Prefix "PROMO"</div>
            <code class="mono" style="font-size: 1.25rem; color: var(--primary-light);">PROMO-ABCD-EFGH-IJKL</code>
        </div>
    </div>
</div>

<div id="qr-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div class="glass-card" style="max-width: 320px; text-align: center;">
        <h3 style="margin-bottom: 1rem;">QR Code</h3>
        <div class="qr-code" id="qr-display"></div>
        <p class="mono" style="margin-top: 1rem; color: var(--primary-light);" id="qr-code-text"></p>
        <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="closeQR()">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const generatedCodes = [{% if generated_codes %}{% for code in generated_codes %}'{{ code }}'{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}];
    
    function copyAllCodes() {
        const text = generatedCodes.join('\n');
        navigator.clipboard.writeText(text).then(() => {
            showToast('All codes copied to clipboard!');
        });
    }
    
    function downloadCSV() {
        const csv = 'Code\n' + generatedCodes.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'activation_codes.csv';
        a.click();
        showToast('CSV downloaded!');
    }
    
    function showQR(code, qrData) {
        document.getElementById('qr-display').innerHTML = `<img src="data:image/png;base64,${qrData}" alt="QR Code" style="max-width: 200px;">`;
        document.getElementById('qr-code-text').textContent = code;
        document.getElementById('qr-modal').style.display = 'flex';
    }
    
    function closeQR() {
        document.getElementById('qr-modal').style.display = 'none';
    }
    
    document.getElementById('qr-modal').addEventListener('click', function(e) {
        if (e.target === this) closeQR();
    });
</script>
{% endblock %}
